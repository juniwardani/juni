<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Supabase Compact Monitor</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <!-- Supabase JS v2 -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root {
      --bg-body: #f3f4f6;
      --bg-card: #ffffff;
      --text-main: #1f2937;
      --text-sub: #6b7280;
      --border: #e5e7eb;
      
      /* Compact Colors */
      --online: #10b981; /* Green */
      --waking: #3b82f6; /* Blue */
      --error: #ef4444;  /* Red */
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      background: var(--bg-body);
      color: var(--text-main);
      margin: 0;
      padding: 15px;
      font-size: 13px; /* Lebih kecil untuk kompak */
    }

    /* --- HEADER COMPACT --- */
    .header-wrapper {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      flex-wrap: wrap;
      gap: 10px;
    }

    .header-title h2 {
      margin: 0;
      font-size: 16px;
      font-weight: 700;
      color: #111827;
    }
    .header-title p {
      margin: 2px 0 0 0;
      font-size: 11px;
      color: var(--text-sub);
    }

    /* Action Button */
    .action-group {
      display: flex;
      gap: 8px;
      align-items: center;
    }
    
    button.btn-main {
      background: #2563eb;
      color: white;
      border: none;
      padding: 6px 14px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 12px;
      font-weight: 600;
      box-shadow: 0 1px 2px rgba(0,0,0,0.1);
    }
    button.btn-main:disabled { background: #93c5fd; cursor: wait; }
    button.btn-main:hover:not(:disabled) { background: #1d4ed8; }

    /* --- SUMMARY COMPACT (Inline) --- */
    .summary-bar {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px;
      margin-bottom: 15px;
    }
    
    .summary-item {
      background: var(--bg-card);
      padding: 8px 12px;
      border-radius: 6px;
      border: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .summary-val { font-weight: 700; font-size: 15px; }
    .summary-lbl { font-size: 10px; text-transform: uppercase; color: var(--text-sub); }

    /* --- LIST ITEM (The Core Compact Design) --- */
    ul { list-style: none; padding: 0; margin: 0; }

    li {
      background: var(--bg-card);
      border: 1px solid var(--border);
      margin-bottom: 6px; /* Jarak item lebih rapat */
      border-radius: 6px;
      padding: 10px 12px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      transition: transform 0.1s;
    }
    li:hover { transform: translateY(-1px); box-shadow: 0 2px 4px rgba(0,0,0,0.05); }

    /* Left Side: Info */
    .item-info { flex: 1; min-width: 0; padding-right: 10px; }
    .item-name { font-weight: 600; font-size: 14px; margin-bottom: 2px; }
    .item-url { 
      font-family: monospace; 
      font-size: 10px; 
      color: var(--text-sub); 
      white-space: nowrap; 
      overflow: hidden; 
      text-overflow: ellipsis; 
    }

    /* Right Side: Stats */
    .item-stats { display: flex; align-items: center; gap: 8px; flex-shrink: 0; }
    
    .latency-tag {
      font-size: 11px;
      color: var(--text-sub);
      min-width: 50px;
      text-align: right;
    }

    .badge {
      font-size: 10px;
      font-weight: 700;
      padding: 3px 8px;
      border-radius: 99px; /* Pill shape */
      text-transform: uppercase;
      min-width: 60px;
      text-align: center;
      letter-spacing: 0.5px;
    }

    /* Status Colors */
    .status-online .badge { background: #d1fae5; color: #065f46; border: 1px solid #a7f3d0; }
    .status-waking .badge { background: #dbeafe; color: #1e40af; border: 1px solid #bfdbfe; }
    .status-error .badge { background: #fee2e2; color: #991b1b; border: 1px solid #fecaca; }
    
    .status-error li { border-left: 3px solid var(--error); }

    /* Footer */
    footer {
      margin-top: 20px;
      text-align: center;
      font-size: 11px;
      color: var(--text-sub);
      border-top: 1px solid var(--border);
      padding-top: 10px;
    }

    /* Utility */
    .error-text {
      display: none; /* Hidden by default */
      position: fixed; 
      bottom: 0; left: 0; right: 0;
      background: #fff; 
      padding: 10px; 
      border-top: 1px solid var(--error);
      font-size: 10px; 
      color: var(--error); 
      text-align: center;
    }

    /* Responsive Tweaks */
    @media (max-width: 480px) {
      .header-wrapper { flex-direction: column; align-items: flex-start; }
      .action-group { width: 100%; }
      button.btn-main { width: 100%; }
      .item-url { max-width: 150px; }
    }
  </style>
</head>
<body>

<div class="header-wrapper">
  <div class="header-title">
    <h2>Supabase Keeper</h2>
    <p>Auto-query ke database (Cold Start Retry ON)</p>
  </div>
  <div class="action-group">
    <button class="btn-main" onclick="runChecks()" id="refreshBtn">Check All</button>
  </div>
</div>

<!-- Summary Compact -->
<div class="summary-bar">
  <div class="summary-item">
    <span class="summary-val" id="count-total">0</span>
    <span class="summary-lbl">Total</span>
  </div>
  <div class="summary-item">
    <span class="summary-val" id="count-online" style="color: var(--online)">0</span>
    <span class="summary-lbl">Active</span>
  </div>
  <div class="summary-item">
    <span class="summary-val" id="count-error" style="color: var(--error)">0</span>
    <span class="summary-lbl">Issue</span>
  </div>
</div>

<ul id="status-list"></ul>

<footer>
  Terakhir checked: <span id="last-ping">-</span>
</footer>

<!-- Error Tooltip Bar -->
<div id="error-bar" class="error-text"></div>

<script>
  // --- 1. KONFIGURASI (KEY DARI USER) ---
  // Peringatan: Key ini sudah dipublikasikan, segera ganti setelah pengujian.
  const projects = [
    {
      name: "Project 1",
      url: "https://fkfwjlsgrnfqyfnlewgn.supabase.co",
      key: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZrZndqbHNncm5mcXlmbmxld2duIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE1MjA4ODYsImV4cCI6MjA3NzA5Njg4Nn0.V7uF638Kodz10Rl87t7Hwy6V4dlrnwKzIsEYAd0J8aA"
    },
    {
      name: "Project 2",
      url: "https://hjvppgbcltgiibdxqtka.supabase.co",
      key: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhqdnBwZ2JjbHRnaWliZHhxdGthIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzQyNzUzNDgsImV4cCI6MjA0OTg1MTM0OH0.3X7KMHg3qMdsgYsulWxC-hGvpjkGt-9V_YTbd7PSeOw"
    },
    {
      name: "Project 3",
      url: "https://trkzfxfrhgbwwmxjwnli.supabase.co",
      key: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRya3pmeGZyaGdid3dteGp3bmxpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzU4NzE5OTMsImV4cCI6MjA1MTQ0Nzk5M30.IRwu5quqWPd10LUiAHVmUkI8eURU1nnj-2KL17HCkCA"
    },
    {
      name: "Project 4",
      url: "https://iwnwqcxigtywetgcmlou.supabase.co",
      key: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml3bndxY3hpZ3R5d2V0Z2NtbG91Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzU4MjQ4MTUsImV4cCI6MjA1MTQwMDgxNX0.fjdJlTVav4Gm8ku9rBmRuLoae5ViFxas7Uu069ItfnY"
    },
    {
      name: "Project 5",
      url: "https://lrkechznknwqnxckyfcg.supabase.co",
      key: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imxya2VjaHpua253cW54Y2t5ZmNnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MjkxMjgzODEsImV4cCI6MjA0NDcwNDM4MX0.Tj8p1u3_DGQnqhPkS6AJGs5BwOSeebdvsknX2qHzwdQ"
    }
  ];

  const listElement = document.getElementById("status-list");
  const refreshBtn = document.getElementById("refreshBtn");
  const errorBar = document.getElementById("error-bar");

  const sleep = (ms) => new Promise(r => setTimeout(r, ms));

  // --- 2. LOGIKA CHECK (DB QUERY + RETRY) ---
  async function checkProject(project) {
    const start = performance.now();
    let status = "ONLINE";
    let statusText = "OK";
    let latency = 0;
    let errorMsg = "";
    let attempts = 0;
    const maxAttempts = 2;

    for (let i = 0; i < maxAttempts; i++) {
      attempts = i + 1;
      try {
        const supabase = window.supabase.createClient(project.url, project.key);
        
        // QUERY DB (WAKEUP)
        const { error } = await supabase
          .from('wakeup_log')
          .select('id')
          .limit(1);

        latency = Math.round(performance.now() - start);

        if (error) throw error;
        break; // Sukses

      } catch (e) {
        latency = Math.round(performance.now() - start);
        
        if (i === 0) {
           const msg = (e.message || "").toLowerCase();
           // Indikasi DB Lagi Bangun
           if (msg.includes("database") || msg.includes("connection") || msg.includes("timeout") || msg.includes("503")) {
             status = "WAKING"; // Sementara visual waking
             await sleep(5000); // Tunggu cold start
             continue;
           }
        }
        
        // Fatal Error
        status = "ERROR";
        statusText = "FAIL";
        
        const msg = e.message.toLowerCase();
        if (msg.includes("jwt") || msg.includes("invalid") || msg.includes("api key")) {
          errorMsg = "Invalid Key / Format Salah";
        } else if (msg.includes("relation") || msg.includes("does not exist")) {
          errorMsg = "Tabel 'wakeup_log' belum dibuat";
        } else {
          errorMsg = e.message;
        }
        break;
      }
    }
    
    if (attempts > 1 && status !== "ERROR") {
      latency = Math.round(performance.now() - start);
      statusText = "OK (Wake)"; // Tanda sudah berhasil setelah cold start
    }

    return { ...project, status, statusText, latency, errorMsg };
  }

  // --- 3. RENDER ---
  async function runChecks() {
    refreshBtn.disabled = true;
    refreshBtn.textContent = "Scanning...";
    listElement.style.opacity = "0.5";

    // Jalankan paralel tapi render sekaligus biar cepat
    const results = await Promise.all(projects.map(p => checkProject(p)));

    // Update Summary
    const total = results.length;
    const online = results.filter(r => r.status === "ONLINE" || r.status === "WAKING").length;
    const error = results.filter(r => r.status === "ERROR").length;

    document.getElementById("count-total").textContent = total;
    document.getElementById("count-online").textContent = online;
    document.getElementById("count-error").textContent = error;

    // Render List
    listElement.innerHTML = "";
    results.forEach(r => {
      const li = document.createElement("li");
      // Class logic
      let statusClass = "status-online";
      if (r.status === "ERROR") statusClass = "status-error";
      if (r.status === "WAKING") statusClass = "status-waking";
      
      li.className = statusClass;

      // Jika ada error, tampilkan di bar bawah jika di-hover/active
      li.onclick = () => {
        if(r.errorMsg) {
          errorBar.style.display = "block";
          errorBar.textContent = `${r.name}: ${r.errorMsg}`;
          setTimeout(() => errorBar.style.display = "none", 5000);
        }
      };

      li.innerHTML = `
        <div class="item-info">
          <div class="item-name">${r.name}</div>
          <div class="item-url">${new URL(r.url).hostname}</div>
        </div>
        <div class="item-stats">
          <span class="latency-tag">${r.latency} ms</span>
          <span class="badge">${r.statusText}</span>
        </div>
      `;
      listElement.appendChild(li);
    });

    listElement.style.opacity = "1";
    refreshBtn.disabled = false;
    refreshBtn.textContent = "Check All";

    // Update Time
    const now = new Date();
    document.getElementById("last-ping").textContent = now.toLocaleTimeString("id-ID");
  }

  // Run start
  runChecks();
</script>

</body>
</html>